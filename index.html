<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ä¿¡ç”¨å¡æ¶ˆè²»åŠ©æ‰‹ (Supabaseç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .card-item {
            transition: transform 0.2s;
        }
        .card-item:active {
            transform: scale(0.98);
        }
        .tag {
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            margin-right: 0.25rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }
        .tag-bank { background-color: #e5e7eb; color: #374151; }
        .highlight-rate {
            color: #dc2626;
            font-weight: 800;
            font-size: 1.25rem;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="pb-10">

    <!-- Header -->
    <div class="bg-green-600 text-white p-4 shadow-md sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">ğŸ’³ é›²ç«¯ä¿¡ç”¨å¡åŠ©æ‰‹</h1>
        <p class="text-center text-green-100 text-xs mt-1">è³‡æ–™ä¾†æºï¼šSupabase Database</p>
    </div>

    <!-- Search Form -->
    <div class="p-4 max-w-md mx-auto bg-white shadow-sm rounded-b-xl mb-4">
        <div class="grid grid-cols-1 gap-4">
            
            <!-- Scenario -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">æ¶ˆè²»å ´æ™¯ (è²·ç”šéº¼?)</label>
                <select id="categorySelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none bg-gray-50">
                    <option value="all">é¡¯ç¤ºæ‰€æœ‰ (All)</option>
                    <option value="dining">ğŸ½ï¸ é¤é£² / é£Ÿè‚†</option>
                    <option value="online">ğŸ›’ ç¶²ä¸Šè³¼ç‰© / ç¶²è³¼</option>
                    <option value="supermarket">ğŸ¥¦ è¶…å¸‚ / ç™¾è²¨ / ç”Ÿæ´»</option>
                    <option value="travel">âœˆï¸ æ—…éŠ / é…’åº— / å¤–å¹£</option>
                    <option value="transport">ğŸšŒ äº¤é€š / è»Šè²»</option>
                    <option value="entertainment">ğŸ¬ å¨›æ¨‚ (é›»å½±/ä¸²æµ)</option>
                    <option value="mobile">ğŸ“± æ‰‹æ©Ÿæ”¯ä»˜ (Apple/Google Pay)</option>
                </select>
            </div>

            <!-- Region -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ç°½å¸³åœ°å€</label>
                <select id="regionSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none bg-gray-50">
                    <option value="local">ğŸ‡­ğŸ‡° æœ¬åœ° (Local)</option>
                    <option value="overseas">ğŸŒ æµ·å¤– / å¤–å¹£ (Overseas)</option>
                    <option value="china">ğŸ‡¨ğŸ‡³ å…§åœ° (China)</option>
                    <option value="japan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (Japan)</option>
                </select>
            </div>

            <button onclick="filterCards()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">
                ğŸ” ç«‹å³æœå°‹
            </button>
        </div>
    </div>

    <!-- Results -->
    <div class="max-w-md mx-auto px-4">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-bold text-gray-800">æ¨è–¦çµæœ</h2>
            <span id="resultCount" class="text-sm text-gray-500"></span>
        </div>
        
        <div id="loadingState" class="text-center py-10">
            <div class="loader mb-2"></div>
            <p class="text-gray-500 text-sm">æ­£åœ¨é€£ç·šè‡³ Supabase è³‡æ–™åº«...</p>
        </div>

        <div id="errorState" class="hidden text-center py-10 text-red-500 bg-red-50 rounded-lg p-4">
            <p class="font-bold">è®€å–å¤±æ•—</p>
            <p class="text-xs mt-1" id="errorMessage">è«‹æª¢æŸ¥ç¶²çµ¡æˆ– API Key è¨­å®š</p>
        </div>
        
        <div id="cardList" class="space-y-3 hidden">
            <!-- Cards will be injected here -->
        </div>
    </div>

    <script>
        // --- 1. Supabase Configuration ---
        const SUPABASE_URL = 'https://vywsazyaqfjkahhjirme.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5d3NhenlhcWZqa2FoaGppcm1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NzU5NjgsImV4cCI6MjA3OTM1MTk2OH0.Jp2L0sGtN3KNrA7lbP3R3g6HE0RMJkG2wjdfhQ3iMjA';
        const TABLE_NAME = 'Cards from AI_2025.11';

        // Initialize Client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let cardsData = [];

        // --- 2. Fetch Data Logic ---
        async function fetchCardsFromSupabase() {
            const loadingDiv = document.getElementById('loadingState');
            const listDiv = document.getElementById('cardList');
            const errorDiv = document.getElementById('errorState');

            try {
                // Select all columns from the table
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*');

                if (error) throw error;

                cardsData = data;
                
                // Hide loading, show list
                loadingDiv.classList.add('hidden');
                listDiv.classList.remove('hidden');
                
                console.log("Data loaded:", cardsData.length, "rows");
                
                // Initial Filter
                filterCards();

            } catch (err) {
                console.error('Supabase Error:', err);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('errorMessage').innerText = err.message || "ç„¡æ³•è®€å–è³‡æ–™è¡¨";
            }
        }

        // --- 3. Keyword Mapping (Same as before) ---
        const keywords = {
            dining: ['é¤é£²', 'é£Ÿè‚†', 'æ‰€æœ‰æ¶ˆè²»', 'Dining', 'å¿…å‹å®¢', 'KFC', 'éº¥ç•¶å‹'],
            online: ['ç¶²ä¸Š', 'ç¶²è³¼', 'æ‰€æœ‰æ¶ˆè²»', 'Online', 'Amazon', 'Netflix'],
            supermarket: ['è¶…å¸‚', 'ç™¾è²¨', 'æ‰€æœ‰æ¶ˆè²»', 'æƒ åº·', 'ç™¾ä½³', 'è¬å¯§', 'å±ˆè‡£æ°', '7-11', '759', 'SOGO', 'IKEA'],
            travel: ['æ—…éŠ', 'å¤–å¹£', 'æµ·å¤–', 'é…’åº—', 'æ‰€æœ‰æ¶ˆè²»', 'èˆªç©º', 'é‡Œæ•¸', 'Lounge', 'åœ‹æ³°'],
            transport: ['äº¤é€š', 'è»Šè²»', 'éš§é“', 'ä¹å·´', 'æ‰€æœ‰æ¶ˆè²»', 'å…¥æ²¹'],
            entertainment: ['å¨›æ¨‚', 'é›»å½±', 'æˆ²é™¢', 'Netflix', 'Disney+', 'æ‰€æœ‰æ¶ˆè²»'],
            mobile: ['æ‰‹æ©Ÿæ”¯ä»˜', 'Apple Pay', 'Google Pay', 'æ‰€æœ‰æ¶ˆè²»']
        };

        const regionKeywords = {
            local: ['æœ¬åœ°', 'æ‰€æœ‰åœ°å€', 'å…¨çƒ'],
            overseas: ['æµ·å¤–', 'å¤–å¹£', 'æ‰€æœ‰åœ°å€', 'å…¨çƒ'],
            china: ['å…§åœ°', 'å¤§ç£å€', 'æ‰€æœ‰åœ°å€', 'å…¨çƒ'],
            japan: ['æ—¥æœ¬', 'æ‰€æœ‰åœ°å€', 'å…¨çƒ', 'å¤–å¹£']
        };

        // --- 4. Filter Logic ---
        function filterCards() {
            const cat = document.getElementById('categorySelect').value;
            const region = document.getElementById('regionSelect').value;
            
            const results = cardsData.filter(card => {
                // Safe access to properties (handle nulls)
                const cardRegion = (card['ç°½å¸³åœ°å€'] || '').toLowerCase();
                const cardMerchants = (card['æŒ‡å®šå•†æˆ¶'] || '').toLowerCase();
                const cardType = (card['æ¶ˆè²»ç¨®é¡'] || '').toLowerCase();
                const cardName = (card['å¡å'] || '').toLowerCase();
                const cardNote = (card['å‚™è¨»'] || '').toLowerCase();

                // 1. Region Check
                let regionMatch = false;
                if (region === 'japan') {
                    if (cardRegion.includes('æ—¥æœ¬') || cardMerchants.includes('æ—¥æœ¬') || cardRegion.includes('å…¨çƒ') || cardRegion.includes('æ‰€æœ‰åœ°å€')) regionMatch = true;
                    if (cardRegion.includes('æœ¬åœ°') && !cardRegion.includes('æ‰€æœ‰')) regionMatch = false;
                } else {
                    const targetRegions = regionKeywords[region];
                    regionMatch = targetRegions.some(k => cardRegion.includes(k));
                }

                // 2. Category Check
                let catMatch = false;
                if (cat === 'all') {
                    catMatch = true;
                } else {
                    const targetKeywords = keywords[cat];
                    const combinedText = (cardType + cardMerchants + cardName + cardNote).toLowerCase();
                    catMatch = targetKeywords.some(k => combinedText.includes(k.toLowerCase()));
                }

                return regionMatch && catMatch;
            });

            // Sort Logic
            results.sort((a, b) => {
                const getRate = (str) => {
                    if (!str) return 0;
                    const match = str.match(/(\d+(\.\d+)?)%/);
                    return match ? parseFloat(match[1]) : 0;
                };
                
                const rateA = getRate(a['å›è´ˆæ•¸å€¼']);
                const rateB = getRate(b['å›è´ˆæ•¸å€¼']);
                return rateB - rateA;
            });

            renderCards(results);
        }

        // --- 5. Render Logic ---
        function renderCards(cards) {
            const container = document.getElementById('cardList');
            const countLabel = document.getElementById('resultCount');
            container.innerHTML = '';
            countLabel.textContent = `å…± ${cards.length} å¼µå¡`;

            if (cards.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä¿¡ç”¨å¡ ğŸ¥²</div>';
                return;
            }

            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 card-item flex flex-col gap-2';
                
                // Highlight Rate Logic
                let rateDisplay = card['å›è´ˆæ•¸å€¼'] || 'N/A';
                if(rateDisplay.includes('/é‡Œ')) {
                    rateDisplay = `<span class="text-blue-600 text-lg font-bold">${rateDisplay}</span>`;
                } else {
                    rateDisplay = `<span class="highlight-rate">${rateDisplay}</span>`;
                }

                // Handle potential null values
                const bank = card['ç™¼å¡æ©Ÿæ§‹'] || '';
                const name = card['å¡å'] || 'æœªå‘½åå¡ç‰‡';
                const rewardType = card['å›é¥‹ç¨®é¡'] || '';
                const merchant = card['æŒ‡å®šå•†æˆ¶'] === 'ä¸é™' ? 'æ‰€æœ‰æ¶ˆè²»' : (card['æŒ‡å®šå•†æˆ¶'] || 'ä¸é™');
                const limit = card['ç°½å¸³ä¸Šé™'] || 'N/A';
                const note = card['å‚™è¨»'];

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="tag tag-bank">${bank}</span>
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${name}</h3>
                        </div>
                        <div class="text-right min-w-[80px]">
                            ${rateDisplay}
                            <div class="text-xs text-gray-400">${rewardType}</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mt-1">
                        <span class="font-semibold text-gray-500">ğŸ¯ æŒ‡å®šå•†æˆ¶/é¡åˆ¥:</span> ${merchant}
                    </div>

                    <div class="bg-gray-50 p-2 rounded text-xs text-gray-500 mt-2">
                        <p>âš ï¸ <strong>ä¸Šé™:</strong> ${limit}</p>
                        ${note ? `<p class="mt-1 text-green-600">ğŸ’¡ ${note}</p>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Start fetching on load
        window.onload = fetchCardsFromSupabase;

    </script>
</body>
</html>
